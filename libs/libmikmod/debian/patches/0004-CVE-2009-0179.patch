From: Javier Serrano Polo <jasp00@terra.es>
Date: Sat, 29 Oct 2011 14:50:57 +0200
Subject: CVE-2009-0179

This patch avoids the segfault when a loading error happens and fixes
the loading of XM files.
---
 loaders/load_xm.c    |    3 ++-
 playercode/mloader.c |   10 ++++++----
 2 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/loaders/load_xm.c b/loaders/load_xm.c
index a81a8ed..2d68539 100644
--- a/loaders/load_xm.c
+++ b/loaders/load_xm.c
@@ -636,7 +636,8 @@ static BOOL LoadInstruments(void)
 				_mm_fseek(modreader,ck,SEEK_SET);
 				for(u=headend-_mm_ftell(modreader);u;u--) _mm_read_UBYTE(modreader);
 
-				if(_mm_eof(modreader)) {
+				/* last instrument is at the end of file in version 0x0104 */
+				if(_mm_eof(modreader) && (mh->version<0x0104 || t<of.numins-1)) {
 					free(nextwav);free(wh);
 					nextwav=NULL;wh=NULL;
 					_mm_errno = MMERR_LOADING_SAMPLEINFO;
diff --git a/playercode/mloader.c b/playercode/mloader.c
index b89618c..15a12ad 100644
--- a/playercode/mloader.c
+++ b/playercode/mloader.c
@@ -450,10 +450,12 @@ MODULE* Player_LoadGeneric_internal(MREADER *reader,int maxchan,BOOL curious)
 	if (!l->Init || l->Init()) {
 		_mm_rewind(modreader);
 		ok = l->Load(curious);
-		/* propagate inflags=flags for in-module samples */
-		for (t = 0; t < of.numsmp; t++)
-			if (of.samples[t].inflags == 0)
-				of.samples[t].inflags = of.samples[t].flags;
+		if (ok) {
+			/* propagate inflags=flags for in-module samples */
+			for (t = 0; t < of.numsmp; t++)
+				if (of.samples[t].inflags == 0)
+					of.samples[t].inflags = of.samples[t].flags;
+		}
 	} else
 		ok = 0;
 
