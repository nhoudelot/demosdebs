Description: Add hardening flags in compiler options
Author: Boris Pek <tehnick-8@mail.ru>
Last-Update: 2012-06-19

--- a/sources/thirdpartylibs/adflib/Demo/Makefile
+++ b/sources/thirdpartylibs/adflib/Demo/Makefile
@@ -8,6 +8,9 @@
 CFLAGS=-I$(LIBDIR) -O2 -Wall -Wno-uninitialized -pedantic
 LDFLAGS=-L$(LIBDIR) -ladf
 
+CFLAGS+=$(shell dpkg-buildflags --get CFLAGS) $(shell dpkg-buildflags --get CPPFLAGS)
+LDFLAGS+=$(shell dpkg-buildflags --get LDFLAGS) -Wl,--as-needed
+
 EXES= unadf
 
 
--- a/sources/thirdpartylibs/adflib/Lib/Makefile
+++ b/sources/thirdpartylibs/adflib/Lib/Makefile
@@ -1,5 +1,5 @@
 # ADFLib Makefile for Unix platforms
-# tested on Solaris 2.6 and Linux 2.0.36 (RedHat 5.2) 
+# tested on Solaris 2.6 and Linux 2.0.36 (RedHat 5.2)
 
 
 # real devices routines location
@@ -13,14 +13,14 @@
 RANLIB=ranlib
 TAR=tar
 
-DEFINES= 
+DEFINES=
 
-CFLAGS=$(DEFINES) -I${NATIV_DIR} -I.. -I. -Wall -ggdb -std=gnu99
+CFLAGS+=$(shell dpkg-buildflags --get CFLAGS) $(shell dpkg-buildflags --get CPPFLAGS)
 
-CC=gcc 
+CC=gcc
 DEPEND=makedepend
 
-LDFLAGS=-L. -ladf
+LDFLAGS+=$(shell dpkg-buildflags --get LDFLAGS) -Wl,--as-needed
 LDSHARED=$(CC)
 
 OBJS=	 adf_hd.o adf_disk.o adf_raw.o adf_bitm.o adf_dump.o\
@@ -40,7 +40,7 @@
 
 # to define LITT_ENDIAN on little endian machines (intel)
 # checks for sizeof(long)=4, sizeof(short)=2, sizeof(int)=4
-defendian.h: myconf 
+defendian.h: myconf
 	(./myconf || true)
 
 adf_nativ.o: ${NATIV_DIR}/adf_nativ.c ${NATIV_DIR}/adf_nativ.h
--- a/sources/thirdpartylibs/adflib/Demo/unadf.c
+++ b/sources/thirdpartylibs/adflib/Demo/unadf.c
@@ -489,8 +489,7 @@
 
     dev = adfMountDev( devname,TRUE );
     if (!dev) {
-        sprintf(strbuf,"Can't mount the dump device '%s'.\n", devname);
-        fprintf(stderr, strbuf);
+        fprintf(stderr,"Can't mount the dump device '%s'.\n", devname);
         adfEnvCleanUp(); exit(1);
     }
     if (!qflag)
--- a/build/Makefile
+++ b/build/Makefile
@@ -13,8 +13,8 @@
 	CFLAGS=-O0 $(INCLUDES) -Wall -g -DDEBUG -fsanitize=address -fno-omit-frame-pointer
 	LDFLAGS= -shared -lc -lm -ldl -lasan
 else
-	CFLAGS=-O3 $(INCLUDES) -Wall
-	LDFLAGS+= -g -shared  -lz -lexpat -ldl
+	CFLAGS=-O3 $(INCLUDES) -Wall $(shell dpkg-buildflags --get CFLAGS)
+	LDFLAGS+= -g -shared $(shell dpkg-buildflags --get LDFLAGS) -Wl,--as-needed -lz -lexpat -ldl
 endif
 
 DISKLOADERPLUGINS_IPF=
